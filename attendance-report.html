<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Report</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    #controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    @media (min-width: 600px) {
      #controls {
        flex-direction: row;
        align-items: center;
      }
    }
    select, input[type="date"], input[type="month"] {
      padding: 8px;
      font-size: 16px;
    }
    .report-toggle {
      display: flex;
      gap: 10px;
    }
    .report-toggle label {
      font-size: 16px;
    }
    #reportSection {
      margin-top: 20px;
    }
    #exportButtons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #2196f3;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background-color: #1976d2;
    }
  </style>
</head>
<body>
  <h2>Attendance Report</h2>
  <div id="controls">
    <select id="classSelect">
      <option value="">Select Class</option>
      <option value="Class 1A">Class 1A</option>
      <option value="Class 1B">Class 1B</option>
      <!-- Add more classes as needed -->
    </select>

    <div class="report-toggle">
      <label><input type="radio" name="reportType" value="daily" checked onchange="toggleDatePicker('daily')"> Daily</label>
      <label><input type="radio" name="reportType" value="monthly" onchange="toggleDatePicker('monthly')"> Monthly</label>
    </div>

    <input type="date" id="date" />
    <input type="month" id="month" style="display:none" />
    <button onclick="fetchReport()">Get Report</button>
  </div>

  <div id="reportSection"></div>
  <div id="exportButtons" style="display:none">
    <button onclick="downloadCSV()">ðŸ“„ Export CSV</button>
    <button onclick="downloadPDF()">ðŸ“• Download PDF</button>
  </div>

  <script>
    let reportType = 'daily';
    let currentTableHTML = '';
    let currentCSV = '';
    const scriptURL = 'YOUR_SCRIPT_URL_HERE';

    function toggleDatePicker(type) {
      reportType = type;
      document.getElementById('date').style.display = type === 'daily' ? 'inline-block' : 'none';
      document.getElementById('month').style.display = type === 'monthly' ? 'inline-block' : 'none';
    }

    async function fetchReport() {
      const cls = document.getElementById('classSelect').value;
      if (!cls) return alert('Please select a class.');

      const dateInput = reportType === 'daily' ? document.getElementById('date').value : document.getElementById('month').value;
      if (!dateInput) return alert('Please select date/month.');

      document.getElementById('reportSection').innerText = 'Loading...';
      let url = scriptURL + `?action=getAttendanceReport&className=${encodeURIComponent(cls)}`;

      if (reportType === 'daily') {
        const dObj = new Date(dateInput);
        const day = String(dObj.getDate()).padStart(2, '0');
        const month = String(dObj.getMonth() + 1).padStart(2, '0');
        const d = `${day}/${month}/${dObj.getFullYear()}`;
        url += `&date=${encodeURIComponent(d)}`;
      } else {
        const [y, m] = dateInput.split('-');
        url += `&month=${m}&year=${y}`;
      }

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (!data || data.length === 0) {
          document.getElementById('reportSection').innerHTML = '<p>No data found.</p>';
          document.getElementById('exportButtons').style.display = 'none';
          return;
        }

        buildTable(data);
      } catch (error) {
        console.error('Error fetching report:', error);
        document.getElementById('reportSection').innerHTML = '<p>Error loading data. Check console for details.</p>';
      }
    }

    function buildTable(data) {
      let html = '<table border="1" cellpadding="5" cellspacing="0"><tr><th>Name</th><th>Roll</th><th>Attendance</th></tr>';
      let csv = 'Name,Roll,Attendance\n';

      data.forEach(student => {
        const name = student.name;
        const roll = student.roll;
        const attendance = student.attendance.join(', ');
        html += `<tr><td>${name}</td><td>${roll}</td><td>${attendance}</td></tr>`;
        csv += `${name},${roll},${attendance}\n`;
      });

      html += '</table>';
      document.getElementById('reportSection').innerHTML = html;
      document.getElementById('exportButtons').style.display = 'flex';
      currentTableHTML = html;
      currentCSV = csv;
    }

    function downloadCSV() {
      const blob = new Blob([currentCSV], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'attendance.csv';
      a.click();
    }

    function downloadPDF() {
      const w = window.open();
      w.document.write(`<html><head><title>Report</title></head><body>${currentTableHTML}</body></html>`);
      w.print();
    }
  </script>
</body>
</html>
