<!DOCTYPE html>
<html>
<head>
  <title>Mark Attendance</title>
</head>
<body>
  <h2>Mark Attendance</h2>
  <select id="classSelect"></select>
  <input type="date" id="attendanceDate" />
  <ul id="studentList"></ul>
  <button onclick="submitAttendance()">Submit</button>

  <script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbyNWTluHoK_rZD0bJXll7g0vZ3f6yr4bQbrRw5FmIeMDJSQyvO6cTcR6oVZK8e-yj1icA/exec";
    const classSelect = document.getElementById("classSelect");
    const studentList = document.getElementById("studentList");
    const dateInput = document.getElementById("attendanceDate");

    const classes = ["Class_1A", "Class_2B", "Class_3C"];
    classes.forEach(cls => {
      const opt = document.createElement("option");
      opt.value = cls;
      opt.text = cls;
      classSelect.appendChild(opt);
    });

    classSelect.addEventListener("change", loadStudents);

    function loadStudents() {
      const className = classSelect.value;
      fetch(`${webAppUrl}?action=getStudents&className=${className}`)
        .then(res => res.json())
        .then(data => {
          studentList.innerHTML = "";
          data.forEach(s => {
            const li = document.createElement("li");
            li.innerHTML = `
              <label>
                <input type="checkbox" data-index="${s.rowIndex}" checked />
                ${s.roll} - ${s.name}
              </label>
            `;
            studentList.appendChild(li);
          });
        });
    }

    function submitAttendance() {
      const className = classSelect.value;
      const date = dateInput.value;
      if (!date) return alert("Please select a date");

      const checkboxes = studentList.querySelectorAll("input[type='checkbox']");
      const data = Array.from(checkboxes).map(cb => ({
        rowIndex: parseInt(cb.dataset.index),
        present: cb.checked
      }));

      fetch(`${webAppUrl}?action=submitAttendance&className=${className}&date=${date}&data=${encodeURIComponent(JSON.stringify(data))}`)
        .then(res => res.json())
        .then(result => {
          alert(result.success ? "Attendance submitted!" : "Error");
        });
    }

    loadStudents();
  </script>
</body>
</html>
